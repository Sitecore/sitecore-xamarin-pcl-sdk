<?xml version="1.0" encoding="utf-8" ?>
<Project DefaultTarget="QuickBuild" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
<!-- "C:\Program Files (x86)\MSBuild\12.0\Bin\MSBuild.exe" BuildMobileSDK.xml /t:log -->


  <!-- For NUnit -->
  <!-- <Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/> -->

  <!-- For Zip Archiving -->
  <Import Project="$(MSBuildExtensionsPath)\ExtensionPack\4.0\MSBuild.ExtensionPack.tasks"/>


<!-- ====================================================  -->
  <PropertyGroup>
  	<!-- newline symbols matter -->
    <ScriptsDirectory>$(MSBuildThisFileDirectory)</ScriptsDirectory>
    <RepositoryRoot>$([System.IO.Path]::GetFullPath('$(MSBuildThisFileDirectory)\..'))</RepositoryRoot>

    <SolutionsDirectory>$(RepositoryRoot)\solutions</SolutionsDirectory>
    <DeploymentDirectory>$(RepositoryRoot)\deployment</DeploymentDirectory>

    <UnitTestReportXml>$(RepositoryRoot)\deployment\UnitTestDesktopReport.xml</UnitTestReportXml>
    <IntegrationTestReportXml>$(RepositoryRoot)\deployment\IntegrationTestDesktopReport.xml</IntegrationTestReportXml>

    <NugetExe>$(RepositoryRoot)\solutions\.nuget\NuGet.exe</NugetExe>

    <UnitTestDesktopBuildDirectory>$(RepositoryRoot)\test\Desktop-NunitLite\UnitTest-Desktop-NUnitLite\bin\Release</UnitTestDesktopBuildDirectory>
    <IntegrationTestDesktopBuildDirectory>$(RepositoryRoot)\test\Desktop-NunitLite\IntegrationTest-Desktop-NUnitLite\bin\Release</IntegrationTestDesktopBuildDirectory>
  </PropertyGroup>


<!-- ====================================================  -->
  <ItemGroup>
    	<!-- Attribute letter case matters -->
  	<ObjDirectories Include="$([System.IO.Directory]::GetDirectories('$(RepositoryRoot)', 'obj', System.IO.SearchOption.AllDirectories))" />
  	<BinDirectories Include="$([System.IO.Directory]::GetDirectories('$(RepositoryRoot)', 'bin', System.IO.SearchOption.AllDirectories))" />

  	<MobileSdkProject Include="$(RepositoryRoot)\lib\SitecoreMobileSDK-PCL\*.csproj" />
    <UnitTestDesktopProject Include="$(RepositoryRoot)\test\Desktop\MobileSDK-UnitTest-Desktop\*.csproj" />

  	<MobileSdkArtefactsDir Include="$(RepositoryRoot)\lib\SitecoreMobileSDK-PCL\bin\Release" />
  	<MobileSdkDll Include="$(RepositoryRoot)\lib\SitecoreMobileSDK-PCL\bin\Release\Sitecore.MobileSDK.dll" />


    <UnitTestDesktopDll Include="$(RepositoryRoot)\test\Desktop\MobileSDK-UnitTest-Desktop\bin\Release\MobileSDK-UnitTest-Desktop.dll" />
    <IntegrationTestDesktopDll Include="$(RepositoryRoot)\test\Desktop\MobileSDK-IntegrationTest-Desktop\bin\Release\MobileSDK-IntegrationTest-Desktop.dll" />
  </ItemGroup>


<!-- ====================================================  -->
  <Target Name="QuickBuild">
    <CallTarget Targets="clean"/>
    <CallTarget Targets="UnitTest"/>
    <CallTarget Targets="SitecoreMobileSDK"/>
    <CallTarget Targets="package"/>
  </Target>

  <Target Name="FullBuild">
    <CallTarget Targets="QuickBuild"/>
    <CallTarget Targets="IntegrationTest"/>
  </Target>

<!-- ====================================================  -->
  <Target Name="SitecoreMobileSDK">
    <Message Text="Building SitecoreMobileSDK..." />
  	<MSBuild 
      Projects="@(MobileSdkProject)" 
      Targets="Build" 
      Properties="Configuration=Release;" 
    />

   	<MakeDir 
      Condition="!Exists('$(DeploymentDirectory)')"
      Directories="$(DeploymentDirectory)" 
    />

    <ItemGroup>
      <MobileSdkArtefacts Include="$(RepositoryRoot)\lib\SitecoreMobileSDK-PCL\bin\Release\*.dll" />
    </ItemGroup>

  	<MSBuild.ExtensionPack.Compression.Zip 
      TaskAction="Create" 
      CompressFiles="@(MobileSdkArtefacts)" 
      ZipFileName="$(DeploymentDirectory)\SitecoreMobileSDK-Full.zip" 
      RemoveRoot="@(MobileSdkArtefactsDir)" 
    />

    <MSBuild.ExtensionPack.Compression.Zip 
      TaskAction="Create" 
      CompressFiles="@(MobileSdkDll)" 
      ZipFileName="$(DeploymentDirectory)\SitecoreMobileSDK-Minimal.zip" 
      RemoveRoot="@(MobileSdkArtefactsDir)" 
    />
  </Target>

<!-- ====================================================  -->
  <Target Name="clean">
  	<RemoveDir Directories="@(ObjDirectories)" />
  	<RemoveDir Directories="@(BinDirectories)" />
  	<RemoveDir Directories="$(DeploymentDirectory)" />
  </Target>


<!-- ====================================================  -->
<Target Name="UnitTest">
    <MakeDir 
      Condition="!Exists('$(DeploymentDirectory)')"
      Directories="$(DeploymentDirectory)" 
    />
    <Message Text="Building MobileSDK-UnitTest-Desktop-NUnitLite..." />
    <MSBuild 
      Projects="$(SolutionsDirectory)\MobileSDK-UnitTest-Desktop-NUnitLite.sln" 
      Targets="Build" 
      Properties="Configuration=Release" 
    />

    <Exec
      Command="UnitTest-Desktop-NUnitLite.exe -out:$(DeploymentDirectory)\UnitTestReport.txt -result:$(DeploymentDirectory)\UnitTestReport.xml"
      WorkingDirectory="$(UnitTestDesktopBuildDirectory)"
      />
</Target>

<Target Name="IntegrationTest">
    <MakeDir 
      Condition="!Exists('$(DeploymentDirectory)')"
      Directories="$(DeploymentDirectory)" 
    />
    <Message Text="Building MobileSdk-IntegrationTest-Desktop-NUnitLite..." />
    <MSBuild 
      Projects="$(SolutionsDirectory)\MobileSdk-IntegrationTest-Desktop-NUnitLite.sln" 
      Targets="Build" 
      Properties="Configuration=Release" 
    />

    <Exec
      Command="IntegrationTest-Desktop-NUnitLite.exe -out:$(DeploymentDirectory)\InegrationTestReport.txt -result:$(DeploymentDirectory)\IntegrationTestReport.xml"
      WorkingDirectory="$(IntegrationTestDesktopBuildDirectory)"
    />
</Target>


<!-- ====================================================  -->
  <Target Name="package">
    <Exec 
      Command="&quot;$(NugetExe)&quot; pack Sitecore.MobileSDK.nuspec"
      WorkingDirectory="$(ScriptsDirectory)\nuget" />

    <Copy
      SourceFiles="$(ScriptsDirectory)\nuget\Sitecore.MobileSDK.dll.1.0.0.nupkg"
      DestinationFolder="$(DeploymentDirectory) "
     />
  </Target>


<!-- ====================================================  -->
  <Target Name="log">
    <Message Text="MobileSdkProject : @(MobileSdkProject)" />
    <Message Text="RepositoryRoot : $(RepositoryRoot)" />
    <Message Text="DeploymentDirectory : $(DeploymentDirectory)" />


    <Message Text="MobileSdkArtefactsDir : @(MobileSdkArtefactsDir)" />
    <Message Text="MobileSdkDll : @(MobileSdkDll)" />
	

	  <Message Text="===========" />
    <Message Text="MobileSdkArtefacts : @(MobileSdkArtefacts, '&#x0d;&#x0a;')" />
    <Message Text="===========" />

	  <Message Text="===========" />
    <Message Text="ObjDirectories : @(ObjDirectories, '&#x0d;&#x0a;')" />
    <Message Text="===========" />

    <Message Text="===========" />
    <Message Text="BinDirectories : @(BinDirectories, '&#x0d;&#x0a;')" />
    <Message Text="===========" />

    <Message Text="UnitTestDesktopProject : @(UnitTestDesktopProject)" />
    <Message Text="UnitTestReportXml : $(UnitTestReportXml)" />
  </Target>

</Project>